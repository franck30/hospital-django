{% extends 'patient/base.html' %}
<!---->{% block body %}
<main>
  <form
    enctype="multipart/form-data"
    id="addDocumentForm"
    action="{% url 'app:patient:add_document' %}"
    method="post"
  >
    {% csrf_token %}
    <div id="selectSection">
      <div class="columns" style="align-items: center;">
        <h2 class="type">New document</h2>
        <div class="spacer"></div>
      </div>

      <hr />
      <div class="vertical-spacer"></div>
      <div class="field">
        <span
          >Provide a title for the document (e.g. Blood Test Report, etc)</span
        >
        <input
          type="text"
          name="title"
          placeholder="Document Title"
          required
          onchange="onTitleChanged(event);"
        />
      </div>
      <div class="field">
        <span>Choose the file from your computer</span>
        <input
          type="file"
          name="file"
          id="file"
          required
          accept="image/*, application/pdf, text/*"
          onchange="onFileChanged(event);"
        />
      </div>

      <div class="vertical-spacer"></div>
      <div class="row" id="profile-changes-option">
        <a href="{% url 'app:patient:documents'%}">
          <button class="btn outlined" type="button">
            Cancel
          </button>
        </a>
        <div class="spacer"></div>
        <button
          disabled
          class="btn primary flex-end"
          id="uploadButton"
          type="submit"
        >
          Upload
        </button>
      </div>
    </div>
  </form>
  <div id="uploadSection">
    <form
      enctype="multipart/form-data"
      id="addDocumentForm"
      action="{% url 'app:patient:add_document' %}"
      method="post"
    >
      {% csrf_token %}
      <input type="hidden" name="title" id="titleInput" />
      <input type="hidden" name="file" id="fileInput" />
    </form>
    <div class="columns" style="align-items: center;">
      <h2 class="type">Uploading</h2>
      <div class="spacer"></div>
      <div class="column">
        <div class="progress-bar">
          <div class="progress-bar fill" id="upload-progress"></div>
        </div>
      </div>
    </div>
    <hr />
    <div class="vertical-spacer"></div>
    <h3 class="type">Your document is being uploaded</h3>
  </div>
</main>

{% endblock body %} {% block script %}

<script>
  function generateFileName(file) {
    extension = file.split(".").pop();
    return `${Math.random() * 100}${Math.random() * 100}.${extension}`;
  }

  var isTitleFilled = false;
  var fileTitle = null;
  var isFileUploaded = false;

  const selectSection = document.getElementById("selectSection");
  const uploadSection = document.getElementById("uploadSection");
  uploadSection.style.display = "none";

  var selectedItemId = "patient_documents";

  function setProgress(percent) {
    const progressElement = document.getElementById("upload-progress");
    progressElement.style.width = `${percent}%`;
  }

  function onTitleChanged(event) {
    fileTitle = event.target.value;
    if (event.target.value) {
      isTitleFilled = true;
    }
    if (isTitleFilled & isFileUploaded) {
      const uploadButton = document.querySelector("#uploadButton");
      uploadButton.removeAttribute("disabled");
    }
  }

  function onFileChanged(event) {
    if (event.target.files.length > 0) {
      isFileUploaded = true;
    }
    if (isTitleFilled & isFileUploaded) {
      const uploadButton = document.querySelector("#uploadButton");
      uploadButton.removeAttribute("disabled");
    }
  }

  function addDocument(url) {
    const formElement = document.getElementById("addDocumentForm");
    const titleInput = document.getElementById("titleInput");
    const urlInput = document.getElementById("urlInput");
    urlInput.value = url;
    titleInput.value = fileTitle;
    formElement.submit();
  }
</script>
{% endblock script %}
